<dom-module id="query-builder">
	<style>

		.dialog {
			@apply(--paper-filter-dialog);
			--paper-dialog-background-color: var(--paper-filter-dialog-background-color);
		}

		paper-toolbar {
			@apply(--paper-filter-toolbar);
			--paper-toolbar-background: var(--paper-filter-toolbar-background);
		}

		.dialog,neon-animatable {
			@apply(--layout-fit);
		}

		.animated {
			margin: 0;
			@apply(--layout-fit);
		}

		.header-bar{
			padding: 10px;
			margin: 0;
			background-color: var(--default-primary-color);
			color: white;
			@apply(--layout-horizontal);
		}

		.heading{
			@apply(--layout-flex);
		}

		.field-container{
			border: 2px;
			background: white;
			height: 100%
		}

		#list{
			height: 100%;
		}

		.field {
			padding: 20px;
			border-bottom: 2px solid #DDD;
		}

		.field-dataset-columns {
			padding-top: 2px;
			padding-bottom: 2px;
			padding-right: 20px;
			padding-left:20px;
			border-bottom: 2px solid #DDD;
		}

		.field-inner {
			padding: 5px;
			cursor: pointer;
		}

		.dataset-columns {
			padding-top: 20px;
			padding-bottom: 20px;
		}

		.animated{
			margin: 0;
			padding: 0;
		}

		paper-dialog-scrollable {
			@apply(--layout-flex);
			padding: 0;
			height: calc(100% - 64px);
		}

		@media (max-width: 600px){
			paper-dialog-scrollable {
				height: calc(100% - 56px);
			}
		}

		.collapse-toggle :hover{
			fill: #66F;
			cursor: pointer;
		}

		.collapse-toggle :active{
			fill: #33F;
		}

	</style>
	<template>
		<paper-dialog id="dialog" class="dialog"
		entry-animation="scale-up-animation"
		exit-animation="fade-out-animation">
		<div class="animated">
			<paper-toolbar>
				<paper-icon-button on-tap="close" icon="close"></paper-icon-button>
				<span class="title">
					Query Builder
				</span>
				<paper-button on-tap="_tapReset" 
				class="reset" 
				hidden$="{{!_hasSelectedFields(selectedItems)}}"
				>Reset
			</paper-button>
			<paper-button on-tap="_tapApply" dialog-confirm>Apply</paper-button>
		</paper-toolbar>
		<paper-dialog-scrollable>
			<!--Plot Types-->
			<div class="field-container">
				<div class="field">
					<div class="layout horizontal">
						<div class="layout flex">
							[[fields.plotTypes.name]]
						</div>
						<div on-click="_selectPlotType" class="collapse-toggle">
							<iron-icon icon="arrow-drop-down-circle"></iron-icon>
							<paper-ripple fit></paper-ripple>
						</div>

					</div>
					<iron-collapse opened="[[fields.plotTypes.isCollapsed]]">
						<paper-material elevation="1">
							<iron-list 	items="[[fields.plotTypes.values]]" as="value">
								<template>
									<div>
										<div class="field-inner">
											<paper-checkbox on-change="_toggleSelect" checked$="[[value.checked]]">
												[[value.name]]
											</paper-checkbox>
											<paper-ripple fit></paper-ripple>
										</div>
									</div>
								</template>
							</iron-list>
						</paper-material>
					</iron-collapse>
				</div>
				<!--Dataset Columns-->
				<div class="field-dataset-columns">
					<div class="layout horizontal">
						<div class="layout flex">
							<paper-dropdown-menu id="datasetDropdown" label="Select Dataset" on-iron-select="_selectDataset" required>
								<paper-listbox class="dropdown-content">
									<template is="dom-repeat" items="[[fields.datasetColumns]]">
										<paper-item item = "[[item]]">[[item.name]]</paper-item>
									</template>
								</paper-listbox>
							</paper-dropdown-menu>
						</div>
						<div on-click="_selectDataSetColumns" class="collapse-toggle">
							<iron-icon icon="arrow-drop-down-circle" class="dataset-columns"></iron-icon>
							<paper-ripple fit></paper-ripple>
						</div>
					</div>
					<iron-collapse opened="[[fields.datasetColumns.isCollapsed]]">
						<paper-material elevation="1">
							<iron-list 	items="[[selectedDataset.values]]" as="value">
								<template>
									<div>
										<div class="field-inner">
											<paper-checkbox on-change="_toggleSelect" checked$="[[value.checked]]">
												[[value.name]]
											</paper-checkbox>
											<paper-ripple fit></paper-ripple>
										</div>
									</div>
								</template>
							</iron-list>
							<template is="dom-if" if="[[selectedDataset.otherVals]]">
								<div style="position:relative;">
									<div class="field-inner" on-click="_selectOtherColumns">
										<font color="blue">Other...</font>
										<paper-ripple fit></paper-ripple>	
									</div>
								</div>
								<iron-collapse opened$=[[selectedDataset.isOtherCollapsed]]>

									<!-- <iron-list 	id="otherDatasetList" items="[[selectedDataset.otherVals]]" as="value"> -->
										<template is="dom-repeat" items="[[selectedDataset.otherVals]]" as="value">
											<div>
												<div class="field-inner">
													<paper-checkbox on-change="_toggleSelect" checked$="[[value.checked]]">
														[[value.name]]
													</paper-checkbox>
													<paper-ripple fit></paper-ripple>
												</div>
											</div>
										</template>
									<!-- </iron-list> -->
								</iron-collapse>
							</template>
						</paper-material>
					</iron-collapse>
				</div>
			</div>
		</paper-dialog-scrollable>
	</div>
</paper-dialog>
</template>
</dom-module>
<script type="text/javascript">
	Polymer({
		is: "query-builder",
		properties: {
			fields : {
				type: Array,
			},
			_selectedField : {
				type: Object,
				value: null
			},
			_selectedFields : {
				type: Array,
				value: []
			},
			selectedItems:{
				type: Number,
				value:0
			},
			_forceRedrawDummy:{
				type:Number,
				value: 0
			},
			selectedDataset:{
				type: Object
			},
		},
		open: function(){
			debugger;
			Polymer.dom(document.body).appendChild(this);
			this._resetFields();
			this.$.dialog.open();
		},
		_selectPlotType: function(e){
			this.set('fields.plotTypes.isCollapsed', !this.fields.plotTypes.isCollapsed);
		},
		_selectDataSetColumns: function(e){
			debugger;
			if(this.$.datasetDropdown.validate())
				this.set('fields.datasetColumns.isCollapsed', !this.fields.datasetColumns.isCollapsed);		
		},
		_selectOtherColumns: function(e){
			debugger;
			if(this.selectedDataset.isOtherCollapsed){
				this.set('selectedDataset.isOtherCollapsed', false);		
			}
			else
				this.set('selectedDataset.isOtherCollapsed', true);
		},
		_tapSelectValues: function(){
			this.$.list.selectedItem = null;
			this.set('_selectedField',null);
		},
		close: function() {
			this.$.dialog.close();
		},
		_toggleSelect: function(e){
			e.model.value.checked = !e.model.value.checked;
			if(e.model.value.checked)
				this._selectedFields.push(e.model.value.name);
			else
				this._selectedFields.splice(this._selectedFields.indexOf(e.model.value.name),1);
			this.set('selectedItems',this._selectedFields.length);
		},
		_tapApply: function(){
			console.log(this._selectedFields);
			this.fire('apply');
		},
		_tapReset: function(){
			this._resetFields();
		},
		_hasSelectedFields: function(len){
			return len > 0;
		},
		_resetFields: function(){
			debugger;
			var response={
				type: "getQueryParams"
			}

			app.fire("home-page-req",response);
			this.set('_selectedFields',[]);
			this.set('selectedDataset',null);
			this.set('selectedItems',0);
			this.$.datasetDropdown._setSelectedItem(null);
		},
		_getCollapsed: function(val){
			debugger;
			if(val == undefined)
				return true;
			return val;
		},
		_selectDataset: function(){
			this.set('selectedDataset',this.$.datasetDropdown.selectedItem.item);
			debugger;
		}
	})
</script>