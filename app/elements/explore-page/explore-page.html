<dom-module id="explore-page">
	<style>
	paper-card {
		margin-bottom:8px;
		width: 100%;
		background-color: white;
	}
	
	.plot-user {
		font-weight: bold;
	}
	.plot-header { 
		@apply(--paper-font-headline);
	}
	.plot-light { 
		color: var(--paper-grey-800); 
	}

	.container {
      @apply(--layout-horizontal);
    }

	.comment{
		border-bottom: solid 1px;
		padding: 1pc;
	}

    .flexchild {
      @apply(--layout-flex);
    }

    .comment-section{
    	background-color: #edebfa;
    	margin: 1pc;
    	border-top: solid #e8e8e8 2px;
    }
	</style>
	<template>
		<template is="dom-repeat" items="[[data]]" >
			<div plot = "[[item]]">
				<paper-card image= "/api/plot/[[item.plot]]">
				  <div class="card-content">
				  	<div class="plot-user">
				  		[[item.submittedByUsername]]
				  	</div>
				  	<div hidden>
				  		[[item._id]]
				  	</div>
				  	<div class="plot-header">
				  		[[item.PlotType]] : [[item.xAxis]] vs. [[item.yAxis]]
				  	</div>
				  	<p class="plot-light">
				    	[[item.caption]]
					</p>
				  </div>
				  <div class="card-actions">
				  	<paper-button on-click="_likePlot" raised>
				  		<template is="dom-if" if="[[!item.liked]]">
				    		<iron-icon icon="favorite-border"></iron-icon>
						</template>
						<template is="dom-if" if="[[item.liked]]">
				    		<iron-icon icon="favorite"></iron-icon>
						</template>
						Like
				  	</paper-button>
					<template is="dom-if" if="[[info.isAdmin]]">
					    <paper-button on-click="_publishPlot" raised>
					    	<template is="dom-if" if="[[!item.published]]">
					    		<iron-icon icon="check-box-outline-blank"></iron-icon>
							</template>
							<template is="dom-if" if="[[item.published]]">
					    		<iron-icon icon="check-box"></iron-icon>
							</template>
							Publish
						</paper-button>
					</template>
					<div class="comment-section">
					<template is="dom-repeat" items="[[item.comments]]">
						<div class="comment plot-light" >
							<b>[[item.username]]</b>: [[item.text]]
						</div>
					</template>
					<form class="container " is="iron-form" method="post">
						<paper-input label="Comment something..." required name="comment" class="flexchild">
		        		</paper-input>
						<paper-button on-click="_sendComment" plotid="[[item._id]]">
							<iron-icon icon="send"></iron-icon>
	    				</paper-button>
					</form>
					</div>
				  </div>
				</paper-card>	
				</div>	    
		</template>
	</template>
</dom-module>
<script type="text/javascript">
	Polymer({
		is: "explore-page",

		properties: {
			method:{
				type:String,
			},
			data:{
				type: [{
					published: Boolean
				}],
			},
			dataId:{
				type: String,
			},
			published:{
				type: Boolean,
				value: true
			},
			info:{
				type:Object,
			}
		},

		// getObject: function(_id){
		// 	for(var i in this.data){
		// 		if(this.data[i]._id == _id){
		// 			return this.data[i];
		// 		}
		// 	}
		// 	return null;
		// },

		getObject: function(_id){
			for(var i in this.data){
				if(this.data[i]._id == _id){
					return i;
				}
			}
			return null;
		},

		_publishPlot: function(event){
			debugger;
			
			var clickedProblem = event.srcElement.parentElement.parentElement.parentElement.plot;
			var path = 'data.' + this.getObject(clickedProblem._id) + '.published';
			this.set(path, !clickedProblem.published);


			var response = {
				type: "togglePublished",
				data:{
					dataID: this.dataId,
					plotID: clickedProblem._id
				}
			};

			console.log(response);

			this.fire("plot-page-req", response);

		},

		_likePlot: function(event){
			
			var clickedProblem = event.srcElement.parentElement.parentElement.parentElement.plot;
			path = 'data.' + this.getObject(clickedProblem._id) + '.liked'
			this.set(path, !clickedProblem.liked);


			var response = {
				type: "toggleLikes",
				data:{
					dataID: this.dataId,
					plotID: clickedProblem._id,
					username : this.info.nickname
				}
			};

			console.log(response);

			this.fire("plot-page-req", response);

		},

		_sendComment: function(event){
			debugger;

			var clickedProblemId = event.srcElement.parentElement.plotid;


			// if(!this.$.form.validate()){
			// 	return;
			// }

			event.preventDefault();
			
			var response = {
				type: "postComment",
				data: {
					dataID: this.dataId,
					plotID: clickedProblemId,
					username : this.info.nickname,
					text: event.srcElement.parentElement.parentElement.serialize().comment,
				}
			};

			console.log(response);

			this.fire("plot-page-req", response);
		},
	})
</script> 	