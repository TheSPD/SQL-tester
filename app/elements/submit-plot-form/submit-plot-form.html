<dom-module id="submit-plot-form">
	<style>
	</style>
	<template>
		<form is="iron-form" id="submissionForm" method="post">
			<template is="dom-if" if="[[user.isAdmin]]">
				<paper-dropdown-menu id="userDropdown" on-click="_checkDropdown" required label="For User" name="userName">
						<paper-listbox id="userDropdownList" class="dropdown-content" selected="{{selectedUser}}">
							<template is="dom-repeat" items="{{users}}">
								<paper-item>{{item.userName}}</paper-item>
							</template>
						</paper-listbox>
				</paper-dropdown-menu>
			</template>
			<paper-dropdown-menu on-click="_checkDropdown" required label="Plot Type" name="plotType">
					<paper-listbox class="dropdown-content" selected="{{selectedPlotType}}">
						<template is="dom-repeat" items="{{allPlots}}">
							<paper-item>{{item}}</paper-item>
						</template>
					</paper-listbox>
			</paper-dropdown-menu>
			<div class="layout horizontal">
				<paper-dropdown-menu on-click="_checkDropdown" required label="X-axis" name="xAxis" value="{{xAxis}}">
						<paper-listbox class="dropdown-content" selected="{{selectedxAxis}}">
							<template is="dom-repeat" items="{{allColumns}}">
								<paper-item>{{item.name}}</paper-item>
							</template>
						</paper-listbox>
				</paper-dropdown-menu>
				<paper-input label="Please Specify Field Name" hidden$="[[!_isOtherSelected(xAxis)]]" required$="[[_isOtherSelected(xAxis)]]" value="{{xAxisOther}}">
				</paper-input>
			</div>
			<div class="layout horizontal">
				<paper-dropdown-menu on-click="_checkDropdown" required label="Y-axis" name="yAxis" value="{{yAxis}}">
						<paper-listbox class="dropdown-content" selected="{{selectedyAxis}}">
							<template is="dom-repeat" items="{{allColumns}}">
								<paper-item>{{item.name}}</paper-item>
							</template>
						</paper-listbox>
				</paper-dropdown-menu>
				<paper-input label="Please Specify Field Name" hidden$="[[!_isOtherSelected(yAxis)]]" required$="[[_isOtherSelected(yAxis)]]" value="{{yAxisOther}}">
				</paper-input>
			</div>
			<br>
			<paper-input hidden label="File Upload Path" name="fileLocation" value="{{fileLocation}}">
			</paper-input>
			<vaadin-upload 	
							id="fileUpload"
							name="userPhoto" 
							target="/api/uploadImage" 
							method="POST"
							max-files="1" 
							timeout=15000
							on-upload-success="_uploadSuccess"
							on-upload-error="_uploadFail"
							i18n="[[i18nPlot]]">
			</vaadin-upload>
			<paper-textarea label="Caption" name="caption" value="{{caption}}"></paper-textarea>
			<paper-button on-click="sendForm">Submit
				</paper-button>
		</form>
	</template>
</dom-module>
<script type="text/javascript">
	Polymer({
		is: "submit-plot-form",
		properties: {
			fileLocation: {
				type: String,
			},
			method: {
				type: String,
			},
			dataId: {
				type: String,
			},
			allPlots: {
				type: Array,
				value: ['Scatter', 'Bar', 'Mosaic', 'Stacked Bar', 'Grouped Bar', 'Line', 'Other']
			},
			allColumns: {
				type: Array,
			},
			user: {
				type: Object,
			},
			users: {
				type: Array,
			},
			xAxis: {
				type: String,
				value : ""
			},
			yAxis: {
				type: String,
				value: ""
			},
			selectedUser: {
				type: String,
			},
			selectedPlotType: {
				type: String,
			},
			selectedxAxis: {
				type: String
			},
			selectedyAxis: {
				type:String
			},
			caption:{
				type: String
			},
			i18nPlot: {
						type: Object,
						value: function() {
							return {
								dropFiles: {
									one: 'Drop file here...',
									many: 'Drop files here...'
								},
								addFiles: {
									one: 'Select Plot',
									many: 'Upload Plot'
								},
								cancel: 'Cancel',
								error: {
									tooManyFiles: 'Too Many Files.',
									fileIsTooBig: 'File is Too Big.',
									incorrectFileType: 'Incorrect File Type.'
								},
								uploading: {
									status: {
										connecting: 'Connecting...',
										stalled: 'Stalled.',
										processing: 'Processing File...'
									},
									remainingTime: {
										prefix: 'remaining time: ',
										unknown: 'unknown remaining time'
									},
									error: {
										serverUnavailable: 'Server Unavailable',
										unexpectedServerError: 'Unexpected Server Error',
										forbidden: 'Forbidden'
									}
								},
								units: {
									size: ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
								}
							};
						}
				},
		},
		_checkDropdown: function(event){
			event.currentTarget.validate()
		},
		_uploadSuccess: function(event){
			debugger;
			this.fileLocation = JSON.parse(event.detail.xhr.response).data.path;
			console.log(this.fileLocation);
		},
		_uploadFail: function(event){
			debugger;
			event.detail.file.error = JSON.parse(event.detail.xhr.response).data;
		},
		sendForm:function(){

			if(!this.$.submissionForm.validate()){
				return;
			}

			var response = {
				type: this.method,
				formInputs: this.$.submissionForm.serialize()
			};

			if(this._isOtherSelected(this.xAxis)){
				response.formInputs.isXOther = true;
				response.formInputs.xAxis = this.xAxisOther;
			}

			if(this._isOtherSelected(this.yAxis)){
				response.formInputs.isYOther = true;
				response.formInputs.yAxis = this.yAxisOther;
			}

			response.formInputs.dataId = this.dataId;
			response.formInputs.fileLocation = this.fileLocation;
			
			if(this.user.isAdmin){
				response.formInputs.userId = this._getUserId(response.formInputs.userName);	
			}
			else{
				response.formInputs.userId = this.user._id;
			}
			
			this.fire("plot-form-sent", response);

			debugger;
			// this.$.submissionForm.reset();
			this.selectedUser = null;
			this.selectedPlotType = null;
			this.selectedxAxis = null;
			this.selectedyAxis = null;
			this.fileLocation = null;
			this.caption = null;
			this.$$("#fileUpload")._removeFile(this.$$("#fileUpload").files[0]);

			page('/');
		},
		_getUserId: function(userName){
			for(var user in this.users) {
				if(this.users[user].userName == userName)
					return this.users[user]._id;
			}
		},
		_isOtherSelected: function(value){
			return value == "Other";
		}
	})
</script>