<dom-module id="edit-plot">
	<style>
		.image{
			width: 400px;
			height:300px;
			border: 2px solid var(--default-primary-color);
			border-radius: 5px;
			@apply(--layout-horizontal);
			@apply(--layout-center-justified);
		}
		.image-container{
			width: 100%;
			@apply(--layout-horizontal);
			@apply(--layout-center-justified);

		}
	</style>
	<template>
		<form is="iron-form" id="submissionForm" method="post">
			<template is="dom-if" if="[[user.isAdmin]]">
				<paper-dropdown-menu on-click="_checkDropdown" required label="For User" name="userName" disabled>
					<paper-listbox selected="[[_getUserNumber(plot.submittedBy.userName,users)]]" class="dropdown-content">
						<template is="dom-repeat" items="{{users}}">
							<paper-item>{{item.userName}}</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
			</template>
			<paper-dropdown-menu on-click="_checkDropdown" required label="Plot Type" name="plotType">
					<paper-listbox class="dropdown-content" selected="{{_getPlotTypeNumber(plot.plotType,allPlots)}}">
						<template is="dom-repeat" items="{{allPlots}}">
							<paper-item>{{item}}</paper-item>
						</template>
					</paper-listbox>
			</paper-dropdown-menu>
			<div class="layout horizontal">
				<paper-dropdown-menu on-click="_checkDropdown" required label="X-axis" name="xAxis" value="{{xAxis}}">
						<paper-listbox class="dropdown-content" selected="[[_getSelectedColumnNumber(plot.xAxis,allColumns)]]">
							<template is="dom-repeat" items="{{allColumns}}">
								<paper-item>{{item.name}}</paper-item>
							</template>
						</paper-listbox>
				</paper-dropdown-menu>
				<paper-input name="xAxisOther" label="Other" hidden$="[[!_isOtherSelected(xAxis)]]" required$="[[_isOtherSelected(xAxis)]]" value="{{xAxisOther}}">
				</paper-input>
			</div>
			<div class="layout horizontal">
				<paper-dropdown-menu on-click="_checkDropdown" required label="Y-axis" name="yAxis" value="{{yAxis}}">
						<paper-listbox class="dropdown-content" selected="[[_getSelectedColumnNumber(plot.yAxis,allColumns)]]">
							<template is="dom-repeat" items="{{allColumns}}">
								<paper-item>{{item.name}}</paper-item>
							</template>
						</paper-listbox>
				</paper-dropdown-menu>
				<paper-input name="yAxisOther" label="Other" hidden$="[[!_isOtherSelected(yAxis)]]" required$="[[_isOtherSelected(yAxis)]]" value="{{yAxisOther}}">
				</paper-input>
			</div>

			<div class="image-container">
				<iron-image sizing="contain" class="image" src="/api/plot/[[plot.plot]]">					
				</iron-image>
			</div>
			<br>
			<paper-input hidden label="File Upload Path" name="fileLocation" value="{{fileLocation}}">
			</paper-input>
			<vaadin-upload 	name="userPhoto" 
							target="/api/uploadImage" 
							method="POST"
							max-files="1" 
							timeout=15000
							on-upload-success="_uploadSuccess"
							on-upload-error="_uploadFail"
							i18n="[[i18nPlot]]">
			</vaadin-upload>
			<paper-textarea label="Caption" name="caption" value="{{plot.caption}}"></paper-textarea>
			<paper-button on-click="sendForm">Submit
				</paper-button>
		</form>
	</template>
</dom-module>
<script type="text/javascript">
	Polymer({
		is: "edit-plot",
		properties: {
			plot:{
				type: Object,
			},
			fileLocation: {
				type: String,
			},
			method: {
				type: String,
			},
			dataId: {
				type: String,
			},
			allPlots: {
				type: Array,
				value: ['Scatter', 'Bar', 'Mosaic', 'Stacked Bar', 'Grouped Bar', 'Line', 'Other']
			},
			allColumns: {
				type: Array,
			},
			user: {
				type: Object,
			},
			users: {
				type: Array,
			},
			xAxis: {
				type: String,
				value : ""
			},
			yAxis: {
				type: String,
				value: ""
			},
			xAxisOther: {
				type: String,
				computed : "_getSelectedOtherColumn(plot.xAxis,allColumns)"
			},
			yAxisOther: {
				type: String,
				computed : "_getSelectedOtherColumn(plot.yAxis,allColumns)"
			},
			i18nPlot: {
						type: Object,
						value: function() {
							return {
								dropFiles: {
									one: 'Drop file here...',
									many: 'Drop files here...'
								},
								addFiles: {
									one: 'Select Plot',
									many: 'Upload Plot'
								},
								cancel: 'Cancel',
								error: {
									tooManyFiles: 'Too Many Files.',
									fileIsTooBig: 'File is Too Big.',
									incorrectFileType: 'Incorrect File Type.'
								},
								uploading: {
									status: {
										connecting: 'Connecting...',
										stalled: 'Stalled.',
										processing: 'Processing File...'
									},
									remainingTime: {
										prefix: 'remaining time: ',
										unknown: 'unknown remaining time'
									},
									error: {
										serverUnavailable: 'Server Unavailable',
										unexpectedServerError: 'Unexpected Server Error',
										forbidden: 'Forbidden'
									}
								},
								units: {
									size: ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']
								}
							};
						}
				},
		},
		_getUserNumber: function(userName, users){
			for (var user in users){
				if (users[user].userName == userName){
					return parseInt(user);
				}
			}
			return -1;
		},
		_getPlotTypeNumber: function(plotType, allPlots){
			return allPlots.indexOf(plotType);
		},
		_checkDropdown: function(event){
			event.currentTarget.validate()
		},
		_uploadSuccess: function(event){
			this.fileLocation = JSON.parse(event.detail.xhr.response).data.path;
			console.log(this.fileLocation);
		},
		_uploadFail: function(event){
			event.detail.file.error = JSON.parse(event.detail.xhr.response).data;
		},
		_getSelectedColumnNumber(val,cols){
			for(var col in cols){
				if(cols[col].name == val){
					return col;
				}
			}

			return cols.length-1;
		},
		_getSelectedOtherColumn: function(val,cols){
			for(var col in cols){
				if(cols[col].name == val){
					return null;
				}
			}
			return val;
		},
		sendForm:function(){

			if(!this.$.submissionForm.validate()){
				return;
			}

			var response = {
				type: this.method,
				formInputs: this.$.submissionForm.serialize()
			};

			if(this._isOtherSelected(this.xAxis)){
				response.formInputs.isXOther = true;
				response.formInputs.xAxis = response.formInputs.xAxisOther;
			}


			if(this._isOtherSelected(this.yAxis)){
				response.formInputs.isYOther = true;
				response.formInputs.yAxis = response.formInputs.yAxisOther;
			}

			response.formInputs.dataId = this.dataId;
			response.formInputs.fileLocation = this.fileLocation;
			
			if(this.user.isAdmin){
				response.formInputs.userId = this._getUserId(response.formInputs.userName);	
			}
			else{
				response.formInputs.userId = this.user._id;
			}

			response.formInputs.plotId = this.plot._id;
			
			this.fire("plot-form-sent", response);

			page('/');
		},
		_getUserId: function(userName){
			for(var user in this.users) {
				if(this.users[user].userName == userName)
					return this.users[user]._id;
			}
		},
		_isOtherSelected: function(value){
			return value == "Other";
		}
	})
</script>