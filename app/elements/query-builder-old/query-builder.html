<dom-module id="query-builder">
	<style>

		.dialog {
			@apply(--paper-filter-dialog);
			--paper-dialog-background-color: var(--paper-filter-dialog-background-color);
		}

		paper-toolbar {
			@apply(--paper-filter-toolbar);
			--paper-toolbar-background: var(--paper-filter-toolbar-background);
		}

		.dialog,neon-animatable {
			@apply(--layout-fit);
		}

		.animated {
			margin: 0;
			@apply(--layout-fit);
		}

		.header-bar{
			padding: 10px;
			margin: 0;
			background-color: var(--default-primary-color);
			color: white;
			@apply(--layout-horizontal);
		}

		.heading{
			@apply(--layout-flex);
		}

		.field {
			padding: 20px;
			border-bottom: 2px solid #DDD;
			cursor: pointer;
		}

		.field-container{
			border: 2px;
			background: white;
		}

		.animated{
			margin: 0;
		}
	</style>
	<template>
		<paper-dialog id="dialog" class="dialog"
		entry-animation="scale-up-animation"
		exit-animation="fade-out-animation">
		<neon-animated-pages 	class="animated" 
													selected="[[_getSelectedPage(_selectedField)]]" 
													entry-animation="fade-in-animation" 
													exit-animation="fade-out-animation">
			<neon-animatable>
				<paper-toolbar>
					<paper-icon-button on-tap="close" icon="close"></paper-icon-button>
					<span class="title">
						Query Builder
					</span>
					<paper-button on-tap="_tapReset" 
												class="reset" 
												hidden$="{{!_hasSelectedFields(selectedItems,_forceRedraw)}}"
												>Reset
					</paper-button>
					<paper-button on-tap="_tapApply" dialog-confirm>Apply</paper-button>
				</paper-toolbar>
				<div class="field-container">
					<iron-list 	id="list" 
											items="[[fields]]" 
											as="item" 
											selectionEnabled>
						<template>
						<div class="field">
							<div on-click="_selectField">
								[[item.name]]
								<paper-ripple fit></paper-ripple>
							</div>
					  </div>
						</template>
					</iron-list>
				</div>
			</neon-animatable>

			<neon-animatable>
				<paper-toolbar>
					<paper-icon-button icon="arrow-back" on-tap="_tapSelectValues">
						
					</paper-icon-button>
					<span class="title">
						Query Builder
					</span>
				</paper-toolbar>
				<div class="field-container">
					<iron-list 	items="[[_selectedField.values]]" 
								as="item">
						<template>
							<div>
								<div class="field">

								<paper-checkbox on-change="_toggleSelect" checked$="[[item.checked]]">
									[[item.name]]
								</paper-checkbox>
								<paper-ripple fit></paper-ripple>
								</div>
							</div>
						</template>
					</iron-list>
				</div>
			</neon-animatable>
		</neon-animated-pages>
	</paper-dialog>
</template>
</dom-module>
<script type="text/javascript">
	Polymer({
		is: "query-builder",
		properties: {
			fields : {
				type: Array,
			},
			_selectedField : {
				type: Object,
				value: null
			},
			_selectedFields : {
				type: Array,
				value: []
			},
			selectedItems:{
				type: Number,
				value:0
			},
			_forceRedraw:{
				type:Number,
				value: 0
			}
		},
		open: function(){
			debugger;
			Polymer.dom(document.body).appendChild(this);
			this._resetFields();
			this.$.dialog.open();
		},
		_showQuery: function(){
			debugger;
			alert(JSON.stringify(this.$.list.selectedItem));
		},
		_selectField: function(e){
			debugger;
			this.$.list.selectedItem = e.model.item;
			this.set('_selectedField',e.model.item);
		},
		_getSelectedPage: function(_selectedField){
			debugger;
			return !_selectedField ? 0 : 1
		},
		_tapSelectValues: function(){
			this.$.list.selectedItem = null;
			this.set('_selectedField',null);
			// this._redrawFilterValues();
		},
		close: function() {
			this.$.dialog.close();
		},
		_toggleSelect: function(e){
			debugger;
			e.model.item.checked = !e.model.item.checked;
			if(e.model.item.checked)
				this._selectedFields.push(e.model.item.name);
			else
				this._selectedFields.splice(this._selectedFields.indexOf(e.model.item.name),1);
			this.set('selectedItems',this._selectedFields.length);
		},
		_tapApply: function(){
			console.log(this._selectedFields);
			this.fire('apply');
		},
		_tapReset: function(){
			this._resetFields();
		},
		_hasSelectedFields: function(len,_forceRedraw){
			debugger;
			return len > 0;
		},
		_redrawFilterValues: function() {
			this._forceRedraw = Math.random();
		},
		_resetFields: function(){
			var response={
				type: "getQueryParams"
			}

			app.fire("home-page-req",response);
			this.set('_selectedFields',[]);
			this.set('selectedItems',0)
		}
	})
</script>